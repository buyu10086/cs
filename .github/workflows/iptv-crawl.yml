# name: 自动抓取IPTV源并生成m3u8
name: 自动抓取IPTV源并生成m3u8

# 定时触发：每天早上5点、下午5点各一次（适配北京时间，UTC时区换算）
# 手动触发按钮保留
on:
  schedule:
    - cron: '0 21 * * *'  # UTC21点 = 北京时间次日5点（早）
    - cron: '0 9 * * *'   # UTC9点 = 北京时间17点（下午）
  workflow_dispatch:  # 手动触发

jobs:
  crawl-iptv:
    runs-on: ubuntu-22.04  # 稳定版本，适配免费运行器
    timeout-minutes: 60    # 全局超时兜底，避免无限卡顿
    defaults:
      run:
        shell: bash

    steps:
      # 1. 拉取仓库代码（完整历史，避免Git操作冲突）
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 关键：拉取完整Git历史
        timeout-minutes: 5

      # 2. 设置Python3.10环境
      - name: 设置Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
        timeout-minutes: 5

      # 3. 缓存Python依赖（避免重复安装，节省时间）
      - name: 缓存Python依赖包
        uses: actions/cache@v4
        id: cache-pip
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-iptv  # 固定缓存key，适配无requirements.txt
          restore-keys: |
            ${{ runner.os }}-pip-
        timeout-minutes: 3

      # 4. 安装依赖（缓存命中时跳过）
      - name: 安装依赖包
        run: |
          python -m pip install --upgrade pip
          pip install requests
        timeout-minutes: 5
        if: steps.cache-pip.outputs.cache-hit != 'true'

      # 5. 运行抓取脚本（单独步骤超时，核心执行）
      - name: 执行IPTV抓取脚本
        run: python iptv_crawler.py
        timeout-minutes: 45

      # 6. 提交m3u8文件（修复冲突，先同步远程再提交）
      - name: 提交更新后的m3u8文件
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # 核心修复：先强制同步远程最新代码，保证工作区干净
          git fetch origin main
          git reset --hard origin/main
          # 重新添加生成的文件
          git add iptv_playlist.m3u8
          # 仅文件变化时提交，避免空提交
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update IPTV m3u8 file $(date +'%Y-%m-%d %H:%M:%S')" && git push)
        timeout-minutes: 5
