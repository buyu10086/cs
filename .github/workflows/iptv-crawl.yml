name: 每6小时自动更新IPTV地址

on:
  # 1. 定时触发：每6小时执行一次（核心修改）
  schedule:
    - cron: '0 */6 * * *'  # cron表达式：分 时 日 月 周 → 每6小时的0分执行（0点、6点、12点、18点）
  # 2. 手动触发（保留，方便随时测试）
  workflow_dispatch:

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取仓库代码
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # 避免权限冲突

      # 步骤2：设置Python环境（匹配脚本的Python版本）
      - name: 设置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 步骤3：安装系统依赖（解决lxml等包安装失败）
      - name: 安装系统依赖
        run: sudo apt-get update && sudo apt-get install -y libxml2-dev libxslt1-dev

      # 步骤4：安装Python依赖（国内镜像加速）
      - name: 安装Python依赖包
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install requests beautifulsoup4 lxml -i https://pypi.tuna.tsinghua.edu.cn/simple

      # 步骤5：运行IPTV爬虫脚本
      - name: 运行IPTV爬虫生成m3u8文件
        run: python iptv_crawler.py

      # 步骤6：提交并推送更新（带权限和容错）
      - name: 提交更新到仓库
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}  # 需提前配置仓库密钥
        run: |
          git config --global user.name "Gitee Actions"
          git config --global user.email "actions@gitee.com"
          # 检查文件是否存在，避免空提交
          if [ -f "iptv_list.m3u8" ]; then
            git add iptv_list.m3u8
            git commit -m "自动更新IPTV地址（每6小时）: $(date +'%Y-%m-%d %H:%M:%S')" || echo "无更新内容，跳过提交"
            # 使用令牌推送，解决权限问题
            git push https://${GITEE_TOKEN}@gitee.com/你的用户名/你的仓库名.git
          else
            echo "⚠️ 未找到iptv_list.m3u8文件，跳过提交"
          fi
